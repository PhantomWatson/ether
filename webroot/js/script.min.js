function toggleBGFade(e){e||(e=1e3),fading_interval_id?(clearInterval(fading_interval_id),fading_interval_id=0):fading_interval_id=setInterval(function(){adjustBackground()},e)}function adjustBackground(){if(!fading_mouseover_pause){var e=255,t=0,o=document.getElementById("body_tag"),n=new RGBColor(o.style.backgroundColor),a=Math.floor(3*Math.random()),i=0===Math.round(Math.random())?-1:1;0===a?target_color=n.r:1==a?target_color=n.g:2==a&&(target_color=n.b),1==i&&target_color>=e?i=-1:-1==i&&target_color<=t&&(i=1),0===a?n.r+=i:1==a?n.g+=i:2==a&&(n.b+=i),document.getElementById("toggleBGFade").innerHTML=n.toHex(),document.getElementById("toggleBGFade").style.color=n.toHex(),o.style.backgroundColor=n.toHex()}}function d2h(e){return e.toString(16)}function h2d(e){return parseInt(e,16)}function setupThoughtwordLinks(e){e.find("a.thoughtword").click(function(e){e.preventDefault(),overlayContent({url:$(this).attr("href")})})}function setupCloudElaboration(){$("#full_cloud_link").click(function(e){e.preventDefault(),$.ajax({url:"/thoughts/cloud",beforeSend:function(){$("#cloud_loading").show()},success:function(e){$("#cloud_loading").hide(),$("#cloud_elaborator").fadeOut(500);var t=$("#cloud_container");t.fadeOut(500,function(){t.html(e),setupThoughtwordLinks(t),t.fadeIn(500)})}})})}function overlayContent(e){e.hasOwnProperty("push_history_state")||(e.push_history_state=!0);var t=$("#overlaid").data("originUrl");if(e.url==t&&popupIsOpen())return void closePopup(e.push_history_state);0===$("#overlaid").length&&($("body").append($('<div id="overlaid_bg" title="Click to close popup"></div>')),$("body").append($('<div id="overlaid" data-origin-url="'+window.location.pathname+'"></div>')),setupOverlayCloser());var o=$("#overlaid"),n=$("#overlaid_bg"),a=function(t,o,n){var a=n.children('div[data-popup-url="'+t+'"]');return a.length>0?(e.push_history_state&&pushHistoryState(t),a.show(),void n.fadeIn(300)):(o.addClass("loading"),void $.ajax({url:t,beforeSend:function(){},success:function(o){e.hasOwnProperty("success")&&e.success();var a=$("<div></div>");a.html(o),n.append(a),n.fadeIn(300);var i=n.find("> div > div.thought");i.length>0&&setupThoughtwordLinks(i);var r=t;if("/random"==t){var s=a.find("h1").first().html().trim().toLowerCase();r="/t/"+s}e.push_history_state&&pushHistoryState(r),a.attr("data-popup-url",r)},error:function(){},complete:function(){o.removeClass("loading")}}))};if(popupIsOpen())o.fadeOut(300,function(){o.children("div").hide(),a(e.url,n,o)});else{var i=$(window).scrollTop();$("#content_outer").css({overflow:"hidden",maxHeight:"100%"}),$("#content_outer").scrollTop(i),n.fadeIn(300,function(){a(e.url,n,o)})}}function pushHistoryState(e){e!=window.location.pathname&&history.pushState({url:e},"Ether :: "+e,e)}function setupOverlayCloser(){$("#overlaid_bg").click(function(e){closePopup()}),$("html").keydown(function(e){27==e.which&&closePopup()})}function closePopup(e){"undefined"==typeof e&&(e=!0),$("#overlaid").fadeOut(600,function(){$("#overlaid_bg").fadeOut(1e3,function(){if(e){var t=$("#overlaid").data("originUrl");pushHistoryState(t)}$("#overlaid > div").hide();var o=$("#content_outer").scrollTop();$("#content_outer").css({overflow:"auto",maxHeight:"none"}),$(window).scrollTop(o)})})}function popupIsOpen(){return $("#overlaid > div:visible").length>0}function setupOnPopState(){window.onpopstate=function(e){e.state?overlayContent({url:e.state.url,push_history_state:!1}):closePopup(!1)}}function setupHeaderLinks(){$("#random_link, #login_link, #register_link").click(function(e){e.preventDefault(),overlayContent({url:$(this).attr("href")})})}var comment={add:function(e){var t=$("#newcomment"+e+"add");if(!t.is(":visible")){var o=$("#newcomment"+e+"button");o.slideUp(200),t.slideDown(200),t.find("textarea").focus()}},cancel:function(e){var t=$("#newcomment"+e+"add");t.is(":visible")&&($("#newcomment"+e+"button").slideDown(200),t.slideUp(200))},insert:function(e){$("#newcomment"+e+"view").append($("#comment_just_added")),$("#comment_just_added").attr("id",""),$("#newcomment"+e+"add").find("textarea").html(""),this.cancel(e)}},thought={init:function(){$("a.add_comment").click(function(e){e.preventDefault();var t=$(this).data("thoughtId");comment.add(t)}),$("a.cancel_comment").click(function(e){e.preventDefault();var t=$(this).data("thoughtId");comment.cancel(t)})},add:function(){var e=$("#newthoughtadd");e.is(":visible")||(e.slideDown(200,function(){e.find("textarea").focus()}),$("#newthoughtbutton").hide())},cancel:function(){var e=$("#newthoughtadd");e.is(":visible")&&(e.slideUp(200),$("#newthoughtbutton").show())},insert:function(){$("#newthoughtview").prepend($("#thought_just_added")),$("#thought_just_added").attr("id",""),$("#newthoughtadd_form").find("textarea").html(""),this.cancel()},dontWannaThink:function(){$("#wannathink_choices").slideUp(500,function(){$("#wannathink_rejection").slideDown(500)})}},registration={color_avail_request:null,init:function(){new jscolor.color(document.getElementById("color_hex"),{hash:!0});$("#color_hex").change(function(){registrationForm.validateColor()?registrationForm.checkColorAvailability():registrationForm.showColorAjaxMessage("",null)}),$("#UserRegisterForm").submit(function(e){return registrationForm.validateColor()?!0:(alert("Please select a valid color."),!1)})},validateColor:function(){var e=$("#color_hex").val();e.length<7&&"#"!=e.charAt(0)&&(e="#"+e,$("#color_hex").val(e));var t=new RegExp("^#[0-9A-F]{6}$","i");if(!t.test(e)){var o="Bad news."+e+" is not a valid hexadecimal color.";return this.showColorError(o),!1}return!0},showColorError:function(e){var t=$("#reg_color_input .error-message");e!=t.html()&&(t.is(":empty")?(t.html(e),t.slideDown(500)):t.fadeOut(500,function(){t.html(e),t.fadeIn(500)}))},showColorAjaxMessage:function(e,t){var o=$("#reg_color_input .ajax_message");o.is(":empty")?(o.html(e),o.removeClass("success error"),o.addClass(t),o.fadeIn(500)):o.fadeOut(500,function(){o.html(e),o.removeClass("success error"),o.addClass(t),o.fadeIn(500)})},checkColorAvailability:function(){var e=$("#color_hex").val();e=e.replace("#",""),null!==this.color_avail_request&&this.color_avail_request.abort(),this.color_avail_request=$.ajax({url:"/users/checkColorAvailability/"+e,beforeSend:function(){var t='<img src="/img/loading_small.gif" /> Checking to see if #'+e+" is available...";registrationForm.showColorAjaxMessage(t,null)},success:function(t){"1"===t?registrationForm.showColorAjaxMessage("#"+e+" is available! :)","success"):"0"===t?registrationForm.showColorAjaxMessage("#"+e+" is already taken. :(","error"):registrationForm.showColorAjaxMessage("There was an error checking the availability of #"+e+".",null)},error:function(){registrationForm.showColorAjaxMessage("There was an error checking the availability of #"+e+".",null)},complete:function(){this.color_avail_request=null}})}},flashMessage={fadeDuration:300,init:function(){$("#flash_messages ul li").length>0&&this.show(),$("#close_flash_msg").click(function(e){e.preventDefault(),flashMessage.hide()})},show:function(){var e=$("#flash_messages");e.is(":visible")||e.fadeIn(this.fadeDuration)},hide:function(){var e=$("#flash_messages");e.is(":visible")&&e.fadeOut(this.fadeDuration,function(){$("#flash_messages ul").empty()})},insert:function(e,t){var o=$('<li class="'+t+'">'+e+"</li>").hide().fadeIn(this.fadeDuration);$("#flash_messages ul").append(o),$("#flash_messages").is(":visible")||this.show()}},thoughtwordIndex={init:function(){$("body").scrollspy({target:".abc_thoughts_shortcuts",offset:140}),$(".abc_thoughts_shortcuts a").click(function(e){$("html,body").animate({scrollTop:$(this.hash).offset().top},1e3)}),$("#alphabetical_words").find("a.thoughtword").click(function(e){e.preventDefault();$(this).parents("section").children("h2").offset().top;overlayContent({url:$(this).attr("href")})})}},userIndex={init:function(){$("#resize").click(function(e){e.preventDefault();var t=$(".users_index");t.hasClass("resized")?(t.removeClass("resized"),t.children(".colorbox").css({height:"",width:""})):userIndex.resizeColorboxes()})},resizeColorboxes:function(){$(".users_index").addClass("resized"),$(".users_index .colorbox").each(function(){var e=$(this).data("resize"),t=100*(e/100);$(this).css({height:t+"px",width:t+"px"})})}},messages={currentRequest:null,init:function(){$("#conversations_index a").click(function(e){e.preventDefault();var t=$(this).data("color");messages.selectConversation(t)})},cancelCurrentRequest:function(){this.currentRequest&&this.currentRequest.abort(),$("#conversations_index .loading").removeClass("loading")},selectConversation:function(e,t){var o=$("#conversations_index"),n=o.find("a[data-color="+e+"]");this.cancelCurrentRequest(),n.addClass("loading"),this.currentRequest=$.ajax({url:"/messages/conversation/"+e,complete:function(){n.removeClass("loading")},success:function(e){o.find("a.selected").removeClass("selected"),n.addClass("selected");var a=$("#conversation");if(a.length>0?a.fadeOut(150,function(){messages.fadeInConversation(e)}):$("#selected_conversation_wrapper").fadeOut(150,function(){messages.fadeInConversation(e)}),t){var i=o.scrollTop()+n.position().top;o.animate({scrollTop:i},1e3)}}})},fadeInConversation:function(e){var t=$("#selected_conversation_wrapper"),o=$("#conversation");t.html(e),o=$("#conversation"),o.fadeIn(150),t.is(":visible")?o.scrollTop(o.prop("scrollHeight")):t.fadeIn(150,function(){o.scrollTop(o.prop("scrollHeight"))}),t.find("form").submit(function(e){e.preventDefault(),messages.send()})},send:function(){var e=$("#selected_conversation_wrapper"),t=e.find("input[name=recipient]").val(),o={message:e.find("textarea").val(),recipient:t},n=e.find("input[type=submit]");$.ajax({type:"POST",url:"/messages/send",data:o,dataType:"json",beforeSend:function(){n.prop("disabled",!0),$('<img src="/img/loading_small.gif" class="loading" alt="Loading..." />').insertBefore(n)},success:function(e){e.error&&(flashMessage.insert(e.error,"error"),n.prop("disabled",!1),n.siblings("img.loading").remove()),e.success&&messages.selectConversation(t)},error:function(){flashMessage.insert("There was an error sending that message. Please try again.","error"),n.prop("disabled",!1),n.siblings("img.loading").remove()}})}},profile={init:function(){var e=$("#profile_message_form"),t=e.find("textarea"),o=e.find("input[type='submit']"),n=e.find("div.submit");e.submit(function(e){e.preventDefault();var a=$(this).serializeArray(),i=$(this).attr("action");$.ajax({url:i,type:"POST",data:a,beforeSend:function(){o.prop("disabled",!0),t.prop("disabled",!0);var e=$('<img src="/img/loading_small.gif" class="loading" alt="Loading..." />');n.prepend(e),n.find(".result").fadeOut(200,function(){$(this).remove()})},success:function(e,o,a){n.find(".result").remove();var i=$(e);i.hide(),n.prepend(i),i.fadeIn(500),t.val("")},error:function(e,t,o){alert("There was an error sending that message. ("+t+")")},complete:function(){o.prop("disabled",!1),t.prop("disabled",!1),n.find(".loading").remove()}})})}},recentActivity={init:function(){var e=$("#recent");e.find(".nav a").click(function(t){t.preventDefault();var o=$(this);$.ajax({url:o.attr("href"),beforeSend:function(){e.fadeTo(200,.5)},success:function(t){e.fadeOut(100,function(){e.html(t),e.fadeTo(100,1)})},error:function(){e.fadeTo(200,1),alert("Whoops. There was an error. Please try again.")}})})}};