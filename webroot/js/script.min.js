function toggleBGFade(e){e||(e=1e3),fading_interval_id?(clearInterval(fading_interval_id),fading_interval_id=0):fading_interval_id=setInterval(function(){adjustBackground()},e)}function adjustBackground(){if(!fading_mouseover_pause){var e=255,t=0,n=document.getElementById("body_tag"),o=new RGBColor(n.style.backgroundColor),a=Math.floor(3*Math.random()),i=0===Math.round(Math.random())?-1:1;0===a?target_color=o.r:1==a?target_color=o.g:2==a&&(target_color=o.b),1==i&&target_color>=e?i=-1:i==-1&&target_color<=t&&(i=1),0===a?o.r+=i:1==a?o.g+=i:2==a&&(o.b+=i),document.getElementById("toggleBGFade").innerHTML=o.toHex(),document.getElementById("toggleBGFade").style.color=o.toHex(),n.style.backgroundColor=o.toHex()}}function d2h(e){return e.toString(16)}function h2d(e){return parseInt(e,16)}function setupThoughtwordLinks(e){e.find("a.thoughtword").click(function(e){e.preventDefault(),popup.open({url:$(this).attr("href")})})}function setupCloudElaboration(){$("#full_cloud_link").click(function(e){e.preventDefault(),$.ajax({url:"/thoughts/cloud",beforeSend:function(){$("#cloud_loading").show()},success:function(e){$("#cloud_loading").hide(),$("#cloud_elaborator").fadeOut(500);var t=$("#cloud_container");t.fadeOut(500,function(){t.html(e),setupThoughtwordLinks(t),t.fadeIn(500)})}})})}function pushHistoryState(e){e!=window.location.pathname&&history.pushState({url:e},"Ether :: "+e,e)}function setupOnPopState(){window.onpopstate=function(e){e.state?popup.open({url:e.state.url,push_history_state:!1}):popup.close(!1)}}function setupHeaderLinks(){$("#random_link, #login_link, #register_link").click(function(e){e.preventDefault(),popup.open({url:$(this).attr("href")})})}var comment={add:function(e){var t=$("#newcomment"+e+"add");if(!t.is(":visible")){var n=$("#newcomment"+e+"button");n.slideUp(200),t.slideDown(200),t.find("textarea").focus()}},cancel:function(e){var t=$("#newcomment"+e+"add");t.is(":visible")&&($("#newcomment"+e+"button").slideDown(200),t.slideUp(200))},insert:function(e){$("#newcomment"+e+"view").append($("#comment_just_added")),$("#comment_just_added").attr("id",""),$("#newcomment"+e+"add").find("textarea").html(""),this.cancel(e)}},thought={init:function(e){$("a.add_comment").click(function(e){e.preventDefault();var t=$(this).data("thoughtId");comment.add(t)}),$("a.cancel_comment").click(function(e){e.preventDefault();var t=$(this).data("thoughtId");comment.cancel(t)}),$("#add_thought").click(function(e){e.preventDefault(),thought.add()}),$("#cancel_thought").click(function(e){e.preventDefault(),thought.cancel()}),$("#dontwannathink").click(function(e){e.preventDefault(),thought.dontWannaThink()}),this.refreshFormatting(e.formattingKey)},add:function(){var e=$("#newthoughtadd");e.is(":visible")||(e.slideDown(200,function(){e.find("textarea").focus()}),$("#newthoughtbutton").hide())},cancel:function(){var e=$("#newthoughtadd");e.is(":visible")&&(e.slideUp(200),$("#newthoughtbutton").show())},dontWannaThink:function(){$("#wannathink_choices").slideUp(500,function(){$("#wannathink_rejection").slideDown(500)})},refreshFormatting:function(e){if(""!==e){var t=function(e,t){$("div."+e).each(function(){var n=$(this);if(n.data("formatting-key")!=t){var o=n.children(".body");$.ajax({url:"/"+e+"s/refreshFormatting/"+n.data(e+"-id"),dataType:"json",beforeSend:function(){""===o.html().trim()&&o.html('<img src="/img/loading_small.gif" alt="Loading..." />')},success:function(e){e.success&&e.update&&o.html(e.formattedThought)}})}})};t("thought",e),t("comment",e)}}},registration={color_avail_request:null,init:function(){new jscolor.color(document.getElementById("color_hex"),{hash:!0});$("#color_hex").change(function(){registrationForm.validateColor()?registrationForm.checkColorAvailability():registrationForm.showColorAjaxMessage("",null)}),$("#UserRegisterForm").submit(function(e){return!!registrationForm.validateColor()||(alert("Please select a valid color."),!1)})},validateColor:function(){var e=$("#color_hex").val();e.length<7&&"#"!=e.charAt(0)&&(e="#"+e,$("#color_hex").val(e));var t=new RegExp("^#[0-9A-F]{6}$","i");if(!t.test(e)){var n="Bad news."+e+" is not a valid hexadecimal color.";return this.showColorError(n),!1}return!0},showColorError:function(e){var t=$("#reg_color_input .error-message");e!=t.html()&&(t.is(":empty")?(t.html(e),t.slideDown(500)):t.fadeOut(500,function(){t.html(e),t.fadeIn(500)}))},showColorAjaxMessage:function(e,t){var n=$("#reg_color_input .ajax_message");n.is(":empty")?(n.html(e),n.removeClass("success error"),n.addClass(t),n.fadeIn(500)):n.fadeOut(500,function(){n.html(e),n.removeClass("success error"),n.addClass(t),n.fadeIn(500)})},checkColorAvailability:function(){var e=$("#color_hex").val();e=e.replace("#",""),null!==this.color_avail_request&&this.color_avail_request.abort(),this.color_avail_request=$.ajax({url:"/users/checkColorAvailability/"+e,beforeSend:function(){var t='<img src="/img/loading_small.gif" /> Checking to see if #'+e+" is available...";registrationForm.showColorAjaxMessage(t,null)},success:function(t){"1"===t?registrationForm.showColorAjaxMessage("#"+e+" is available! :)","success"):"0"===t?registrationForm.showColorAjaxMessage("#"+e+" is already taken. :(","error"):registrationForm.showColorAjaxMessage("There was an error checking the availability of #"+e+".",null)},error:function(){registrationForm.showColorAjaxMessage("There was an error checking the availability of #"+e+".",null)},complete:function(){this.color_avail_request=null}})}},flashMessage={fadeDuration:300,init:function(){var e=$("#flash_messages");e.children("li").fadeIn(this.fadeDuration),e.find("a").addClass("alert-link")},insert:function(e,t){var n=$('<li role="alert"></li>').addClass("col-sm-offset-2 col-sm-8 alert alert-dismissible alert-"+t).hide();n.append('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'),n.append(e),n.find("a").addClass("alert-link"),$("#flash_messages").append(n),n.fadeIn(this.fadeDuration)}},popup={init:function(){var e=$('<div id="overlaid_bg" title="Click to close popup"></div>');e.click(function(e){popup.close()}),$("html").keydown(function(e){27==e.which&&popup.close()});var t=$('<div id="overlaid" data-origin-url="'+window.location.pathname+'"></div>');$("body").append(e).append(t)},open:function(e){e.hasOwnProperty("push_history_state")||(e.push_history_state=!0);var t=$("#overlaid").data("originUrl");if(e.url==t&&this.isOpen())return void this.close(e.push_history_state);0===$("#overlaid").length&&this.init();var n=$(window).scrollTop();if($("body").addClass("popup_active"),this.isOpen()){var o=$("#overlaid");o.fadeOut(300,function(){o.children("div").hide(),popup.ajaxLoad(e)})}else{var a=$("#overlaid_bg");$("#content_outer").scrollTop(n),a.fadeIn(300,function(){popup.ajaxLoad(e)})}},ajaxLoad:function(e){var t=$("#overlaid"),n=$("#overlaid_bg"),o=t.children('div[data-popup-url="'+e.url+'"]');return o.length>0?(e.push_history_state&&pushHistoryState(e.url),o.show(),void t.fadeIn(300)):(n.addClass("loading"),void $.ajax({url:e.url,success:function(n){e.hasOwnProperty("success")&&e.success();var o=$("<div>"+n+"</div>");t.append(o).fadeIn(300);var a=t.find("> div > div.thought");a.length>0&&setupThoughtwordLinks(a);var i=popup.getDisplayedUrl(e.url);e.push_history_state&&pushHistoryState(i),o.attr("data-popup-url",i)},complete:function(){n.removeClass("loading")}}))},isOpen:function(){return $("#overlaid > div:visible").length>0},close:function(e){"undefined"==typeof e&&(e=!0),$("#overlaid").fadeOut(600,function(){$("#overlaid_bg").fadeOut(1e3,function(){if(e){var t=$("#overlaid").data("originUrl");pushHistoryState(t)}$("#overlaid > div").hide();var n=$("#content_outer").scrollTop();$("body.popup_active").removeClass("popup_active"),$(window).scrollTop(n)})})},getDisplayedUrl:function(e){if("/random"==e){var t=$("#overlaid").find("h1").first().html().trim().toLowerCase();return"/t/"+t}return e}},thoughtwordIndex={init:function(){$(".shortcuts a").click(function(e){e.preventDefault(),$("html,body").animate({scrollTop:$(this.hash).offset().top},1e3)})}},userIndex={init:function(){$("#resize").click(function(e){e.preventDefault();var t=$(".users_index");t.hasClass("resized")?(t.removeClass("resized"),t.children(".colorbox").css({height:"",width:""})):userIndex.resizeColorboxes()})},resizeColorboxes:function(){$(".users_index").addClass("resized"),$(".users_index .colorbox").each(function(){var e=$(this).data("resize"),t=100*(e/100);$(this).css({height:t+"px",width:t+"px"})})}},messages={currentRequest:null,init:function(){$("#conversations_index a").click(function(e){e.preventDefault();var t=$(this).data("color");messages.selectConversation(t)})},scrollToLastMsg:function(){var e=$("#conversation div.row:last-child");0!==e.length&&$(window).scrollTo(e,1e3,{interrupt:!0,offset:-100})},cancelCurrentRequest:function(){this.currentRequest&&this.currentRequest.abort(),$("#conversations_index .loading").removeClass("loading")},selectConversation:function(e,t){var n=$("#conversations_index"),o=n.find("a[data-color="+e+"]");this.cancelCurrentRequest(),o.addClass("loading"),this.currentRequest=$.ajax({url:"/messages/conversation/"+e,complete:function(){o.removeClass("loading")},success:function(e){n.find("a.selected").removeClass("selected"),o.addClass("selected");var a=$("#conversation");if(a.length>0?a.fadeOut(150,function(){messages.fadeInConversation(e)}):$("#selected_conversation_wrapper").fadeOut(150,function(){messages.fadeInConversation(e)}),t){var i=n.scrollTop()+o.position().top;n.animate({scrollTop:i},1e3)}}})},fadeInConversation:function(e){var t=$("#selected_conversation_wrapper"),n=$("#conversation");t.html(e),n=$("#conversation"),n.fadeIn(150),t.is(":visible")?n.scrollTop(n.prop("scrollHeight")):t.fadeIn(150,function(){n.scrollTop(n.prop("scrollHeight"))}),t.find("form").submit(function(e){e.preventDefault(),messages.send()})},send:function(){var e=$("#selected_conversation_wrapper"),t=e.find("input[name=recipient]").val(),n={message:e.find("textarea").val(),recipient:t},o=e.find("input[type=submit]");$.ajax({type:"POST",url:"/messages/send",data:n,dataType:"json",beforeSend:function(){o.prop("disabled",!0),$('<img src="/img/loading_small.gif" class="loading" alt="Loading..." />').insertBefore(o)},success:function(e){e.error&&(flashMessage.insert(e.error,"error"),o.prop("disabled",!1),o.siblings("img.loading").remove()),e.success&&messages.selectConversation(t)},error:function(){flashMessage.insert("There was an error sending that message. Please try again.","error"),o.prop("disabled",!1),o.siblings("img.loading").remove()}})},setupPagination:function(){var e=$(".convo_pagination a"),t=$('<img src="/img/loading_small.gif" class="loading" />');t.hide(),e.append(t),e.click(function(e){e.preventDefault();var t=$(this),n=t.attr("href").split("?");$.ajax({data:n[1],beforeSend:function(){var e=t.children(".loading");return!e.is(":visible")&&void e.show()},success:function(e){var n=t.parents(".row");n.after(e),n.remove(),messages.setupPagination()},error:function(){alert("There was an error loading more messages.")},complete:function(){t.children(".loading").hide()}})})}},profile={init:function(){var e=$("#profile_message_form"),t=e.find("textarea"),n=e.find("input[type='submit']"),o=e.find("div.submit");e.submit(function(e){e.preventDefault();var a=$(this).serializeArray(),i=$(this).attr("action");$.ajax({url:i,type:"POST",data:a,beforeSend:function(){n.prop("disabled",!0),t.prop("disabled",!0);var e=$('<img src="/img/loading_small.gif" class="loading" alt="Loading..." />');o.prepend(e),o.find(".result").fadeOut(200,function(){$(this).remove()})},success:function(e,n,a){o.find(".result").remove();var i=$(e);i.hide(),o.prepend(i),i.fadeIn(500),t.val("")},error:function(e,t,n){alert("There was an error sending that message. ("+t+")")},complete:function(){n.prop("disabled",!1),t.prop("disabled",!1),o.find(".loading").remove()}})})}},recentActivity={init:function(){var e=$("#recent");e.find(".nav a").click(function(t){t.preventDefault();var n=$(this);$.ajax({url:n.attr("href"),beforeSend:function(){e.fadeTo(200,.5)},success:function(t){e.fadeOut(100,function(){e.html(t),e.fadeTo(100,1)})},error:function(){e.fadeTo(200,1),alert("Whoops. There was an error. Please try again.")}})})}},scroll={init:function(){this.hashTargets("comment")&&this.toComment(),$(window).on("hashchange",function(e){e.preventDefault(),scroll.toComment()})},hashTargets:function(e){return"comment"==e&&location.hash.match(/^#c\d+$/)},toComment:function(){var e=location.hash.replace("#","").replace("c","");this.to("[data-comment-id="+e+"]")},to:function(e){var t=$(e);0!==t.length&&$(window).scrollTo(t,1e3,{interrupt:!0,offset:-100})}},search={init:function(){$("#header-search input").on("input",function(){var e=$(this),t=e.val(),n=t.replace(" ","");t!=n&&e.val(n)})}},suggestedWords={init:function(){$("#suggested-words button").click(function(e){e.preventDefault();var t=$(this).html();$("#word").val(t),$("#suggested-words").slideUp(),$("#thought").focus()})}},wordCoalesceTest={init:function(){var e=$("#test-words a");e.each(function(){var e=$(this),t=e.html(),n=t.split("");e.html("");for(var o=0;o<n.length;o++)e.append("<span>"+n[o]+"</span>")}),e.click(function(e){e.preventDefault();var t=$(this),n=t.find("span"),o=[];n.each(function(){o.push($(this).html())}),$("#test-words a[data-word!="+$(this).data("word")+"]").each(function(){var e=$(this),t=e.find("span");t.each(function(){var e=$(this),t=$(this).clone();t.css({zIndex:2,position:"absolute"}),t.addClass("clone"),e.before(t),e.css({opacity:0})}),t=e.find("span.clone"),t.each(function(){var e=$(this);return o.indexOf(e.html())==-1?void e.animate({opacity:0},2e3):void n.each(function(){if(receiverLetter=$(this),receiverLetter.html()==e.html())return e.animate({left:receiverLetter.position().left,top:receiverLetter.position().top},3e3,"swing",function(){$(this).fadeOut(200,function(){$(this).remove()})}),!1})})})})}};