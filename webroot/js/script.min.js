function toggleBGFade(e){e||(e=1e3),fading_interval_id?(clearInterval(fading_interval_id),fading_interval_id=0):fading_interval_id=setInterval(function(){adjustBackground()},e)}function adjustBackground(){if(!fading_mouseover_pause){var e=255,t=0,o=document.getElementById("body_tag"),n=new RGBColor(o.style.backgroundColor),a=Math.floor(3*Math.random()),i=0===Math.round(Math.random())?-1:1;0===a?target_color=n.r:1==a?target_color=n.g:2==a&&(target_color=n.b),1==i&&target_color>=e?i=-1:i==-1&&target_color<=t&&(i=1),0===a?n.r+=i:1==a?n.g+=i:2==a&&(n.b+=i),document.getElementById("toggleBGFade").innerHTML=n.toHex(),document.getElementById("toggleBGFade").style.color=n.toHex(),o.style.backgroundColor=n.toHex()}}function d2h(e){return e.toString(16)}function h2d(e){return parseInt(e,16)}function setupThoughtwordLinks(e){e.find("a.thoughtword").click(function(e){e.preventDefault(),popup.open({url:$(this).attr("href")})})}function setupCloudElaboration(){$("#full_cloud_link").click(function(e){e.preventDefault(),$.ajax({url:"/thoughts/cloud",beforeSend:function(){$("#cloud_loading").show()},success:function(e){$("#cloud_loading").hide(),$("#cloud_elaborator").fadeOut(500);var t=$("#cloud_container");t.fadeOut(500,function(){t.html(e),setupThoughtwordLinks(t),t.fadeIn(500)})}})})}function pushHistoryState(e){e!=window.location.pathname&&history.pushState({url:e},"Ether :: "+e,e)}function setupOnPopState(){window.onpopstate=function(e){e.state?popup.open({url:e.state.url,push_history_state:!1}):popup.close(!1)}}function setupHeaderLinks(){$("#random_link, #login_link, #register_link").click(function(e){e.preventDefault(),popup.open({url:$(this).attr("href")})})}var comment={add:function(e){var t=$("#newcomment"+e+"add");if(!t.is(":visible")){var o=$("#newcomment"+e+"button");o.slideUp(200),t.slideDown(200),t.find("textarea").focus()}},cancel:function(e){var t=$("#newcomment"+e+"add");t.is(":visible")&&($("#newcomment"+e+"button").slideDown(200),t.slideUp(200))},insert:function(e){$("#newcomment"+e+"view").append($("#comment_just_added")),$("#comment_just_added").attr("id",""),$("#newcomment"+e+"add").find("textarea").html(""),this.cancel(e)}},thought={init:function(e){$("a.add_comment").click(function(e){e.preventDefault();var t=$(this).data("thoughtId");comment.add(t)}),$("a.cancel_comment").click(function(e){e.preventDefault();var t=$(this).data("thoughtId");comment.cancel(t)}),$("#add_thought").click(function(e){e.preventDefault(),thought.add()}),$("#cancel_thought").click(function(e){e.preventDefault(),thought.cancel()}),$("#dontwannathink").click(function(e){e.preventDefault(),thought.dontWannaThink()}),this.refreshFormatting(e.formattingKey)},add:function(){var e=$("#newthoughtadd");e.is(":visible")||(e.slideDown(200,function(){e.find("textarea").focus()}),$("#newthoughtbutton").hide())},cancel:function(){var e=$("#newthoughtadd");e.is(":visible")&&(e.slideUp(200),$("#newthoughtbutton").show())},dontWannaThink:function(){$("#wannathink_choices").slideUp(500,function(){$("#wannathink_rejection").slideDown(500)})},refreshFormatting:function(e){if(""!==e){var t=function(e,t){$("div."+e).each(function(){var o=$(this);if(o.data("formatting-key")!=t){var n=o.children(".body");$.ajax({url:"/"+e+"s/refreshFormatting/"+o.data(e+"-id"),dataType:"json",beforeSend:function(){""===n.html().trim()&&n.html('<img src="/img/loading_small.gif" alt="Loading..." />')},success:function(e){e.success&&e.update&&n.html(e.formattedThought)}})}})};t("thought",e),t("comment",e)}}},registration={color_avail_request:null,color_name_request:null,init:function(){new jscolor.color(document.getElementById("color_hex"),{hash:!1});$("#color_hex").change(function(){registration.validateColor()&&(registration.checkColorAvailability(),registration.getColorName())}),$("#UserRegisterForm").submit(function(e){return!!registration.validateColor()||(alert("Please select a valid color."),!1)}),registration.getColorName()},validateColor:function(){var e=$("#color_hex").val(),t=new RegExp("^[0-9A-F]{6}$","i");if(!t.test(e)){var o="Bad news. "+e+" is not a valid hexadecimal color.";return this.showColorFeedback(o,"error"),!1}return!0},showColorFeedback:function(e,t){var o=$("#reg_color_input").find(".evaluation_message");e!==o.html()&&(o.is(":empty")?(o.hide(),o.html(e),o.removeClass("success error"),o.addClass(t),o.slideDown(500)):o.fadeOut(100,function(){o.html(e),o.removeClass("success error"),o.addClass(t),o.fadeIn(500)}))},checkColorAvailability:function(){var e=$("#color_hex").val();null!==this.color_avail_request&&this.color_avail_request.abort(),this.color_avail_request=$.ajax({url:"/users/checkColorAvailability/"+e,dataType:"json",beforeSend:function(){var e="Checking to see if that color is available...";registration.showColorFeedback(e,null)},success:function(e){e.hasOwnProperty("available")&&"boolean"==typeof e.available?e.available===!0?registration.showColorFeedback("This color is available! :)","success"):e.available===!1&&registration.showColorFeedback("This color is already taken. :(","error"):registration.showColorFeedback("There was an error checking the availability of that color.",null)},error:function(){registration.showColorFeedback("There was an error checking the availability of that color.",null)},complete:function(){registration.color_avail_request=null}})},getColorName:function(){var e=$("#color_hex").val();null!==this.color_name_request&&this.color_name_request.abort();var t=$("#reg_color_input").find("label");this.color_name_request=$.ajax({url:"/colors/get-name/"+e,dataType:"json",beforeSend:function(){t.html('Color: <img src="/img/loading_small.gif" class="loading" alt="Loading..." />')},success:function(e){e.hasOwnProperty("name")?t.html('Color: "'+e.name+'"'):(t.html("Color"),console.log("Error retrieving color name"))},error:function(){t.html("Color"),console.log("Error retrieving color name")},complete:function(){registration.color_name_request=null}})}},flashMessage={fadeDuration:300,init:function(){var e=$("#flash_messages");e.children("li").fadeIn(this.fadeDuration),e.find("a").addClass("alert-link")},insert:function(e,t){var o=$('<li role="alert"></li>').addClass("col-sm-offset-2 col-sm-8 alert alert-dismissible alert-"+t).hide();o.append('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'),o.append(e),o.find("a").addClass("alert-link"),$("#flash_messages").append(o),o.fadeIn(this.fadeDuration)}},popup={init:function(){var e=$('<div id="overlaid_bg" title="Click to close popup"></div>');e.click(function(e){popup.close()}),$("html").keydown(function(e){27==e.which&&popup.close()});var t=$('<div id="overlaid" data-origin-url="'+window.location.pathname+'"></div>');$("body").append(e).append(t)},open:function(e){e.hasOwnProperty("push_history_state")||(e.push_history_state=!0);var t=$("#overlaid").data("originUrl");if(e.url==t&&this.isOpen())return void this.close(e.push_history_state);0===$("#overlaid").length&&this.init();var o=$(window).scrollTop();if($("body").addClass("popup_active"),this.isOpen()){var n=$("#overlaid");n.fadeOut(300,function(){n.children("div").hide(),popup.ajaxLoad(e)})}else{var a=$("#overlaid_bg");$("#content_outer").scrollTop(o),a.fadeIn(300,function(){popup.ajaxLoad(e)})}},ajaxLoad:function(e){var t=$("#overlaid"),o=$("#overlaid_bg"),n=t.children('div[data-popup-url="'+e.url+'"]');return n.length>0?(e.push_history_state&&pushHistoryState(e.url),n.show(),void t.fadeIn(300)):(o.addClass("loading"),void $.ajax({url:e.url,success:function(o){e.hasOwnProperty("success")&&e.success();var n=$("<div>"+o+"</div>");t.append(n).fadeIn(300);var a=t.find("> div > div.thought");a.length>0&&setupThoughtwordLinks(a);var i=popup.getDisplayedUrl(e.url);e.push_history_state&&pushHistoryState(i),n.attr("data-popup-url",i)},complete:function(){o.removeClass("loading")}}))},isOpen:function(){return $("#overlaid > div:visible").length>0},close:function(e){"undefined"==typeof e&&(e=!0),$("#overlaid").fadeOut(600,function(){$("#overlaid_bg").fadeOut(1e3,function(){if(e){var t=$("#overlaid").data("originUrl");pushHistoryState(t)}$("#overlaid > div").hide();var o=$("#content_outer").scrollTop();$("body.popup_active").removeClass("popup_active"),$(window).scrollTop(o)})})},getDisplayedUrl:function(e){if("/random"==e){var t=$("#overlaid").find("h1").first().html().trim().toLowerCase();return"/t/"+t}return e}},thoughtwordIndex={init:function(){$(".shortcuts a").click(function(e){e.preventDefault(),$("html,body").animate({scrollTop:$(this.hash).offset().top},1e3)})}},userIndex={init:function(){$("#resize").click(function(e){e.preventDefault();var t=$(".users_index");t.hasClass("resized")?(t.removeClass("resized"),t.children(".colorbox").css({height:"",width:""})):userIndex.resizeColorboxes()})},resizeColorboxes:function(){$(".users_index").addClass("resized"),$(".users_index .colorbox").each(function(){var e=$(this).data("resize"),t=100*(e/100);$(this).css({height:t+"px",width:t+"px"})})}},messages={currentRequest:null,init:function(){$("#conversations_index a").click(function(e){e.preventDefault();var t=$(this).data("color");messages.selectConversation(t)})},scrollToLastMsg:function(){var e=$("#conversation div.row:last-child");0!==e.length&&$(window).scrollTo(e,1e3,{interrupt:!0,offset:-100})},cancelCurrentRequest:function(){this.currentRequest&&this.currentRequest.abort(),$("#conversations_index .loading").removeClass("loading")},selectConversation:function(e,t){var o=$("#conversations_index"),n=o.find("a[data-color="+e+"]");this.cancelCurrentRequest(),n.addClass("loading"),this.currentRequest=$.ajax({url:"/messages/conversation/"+e,complete:function(){n.removeClass("loading")},success:function(e){o.find("a.selected").removeClass("selected"),n.addClass("selected");var a=$("#conversation");if(a.length>0?a.fadeOut(150,function(){messages.fadeInConversation(e)}):$("#selected_conversation_wrapper").fadeOut(150,function(){messages.fadeInConversation(e)}),t){var i=o.scrollTop()+n.position().top;o.animate({scrollTop:i},1e3)}}})},fadeInConversation:function(e){var t=$("#selected_conversation_wrapper"),o=$("#conversation");t.html(e),o=$("#conversation"),o.fadeIn(150),t.is(":visible")?o.scrollTop(o.prop("scrollHeight")):t.fadeIn(150,function(){o.scrollTop(o.prop("scrollHeight"))}),t.find("form").submit(function(e){e.preventDefault(),messages.send()})},send:function(){var e=$("#selected_conversation_wrapper"),t=e.find("input[name=recipient]").val(),o={message:e.find("textarea").val(),recipient:t},n=e.find("input[type=submit]");$.ajax({type:"POST",url:"/messages/send",data:o,dataType:"json",beforeSend:function(){n.prop("disabled",!0),$('<img src="/img/loading_small.gif" class="loading" alt="Loading..." />').insertBefore(n)},success:function(e){e.error&&(flashMessage.insert(e.error,"error"),n.prop("disabled",!1),n.siblings("img.loading").remove()),e.success&&messages.selectConversation(t)},error:function(){flashMessage.insert("There was an error sending that message. Please try again.","error"),n.prop("disabled",!1),n.siblings("img.loading").remove()}})},setupPagination:function(){var e=$(".convo_pagination a"),t=$('<img src="/img/loading_small.gif" class="loading" alt="Loading..."/>');t.hide(),e.append(t),e.click(function(e){e.preventDefault();var t=$(this),o=t.attr("href").split("?");$.ajax({data:o[1],beforeSend:function(){var e=t.children(".loading");return!e.is(":visible")&&void e.show()},success:function(e){var o=t.parents(".row");o.after(e),o.remove(),messages.setupPagination()},error:function(){alert("There was an error loading more messages.")},complete:function(){t.children(".loading").hide()}})})}},profile={init:function(){var e=$("#profile_message_form"),t=e.find("textarea"),o=e.find("input[type='submit']"),n=e.find("div.submit");e.submit(function(e){e.preventDefault();var a=$(this).serializeArray(),i=$(this).attr("action");$.ajax({url:i,type:"POST",data:a,beforeSend:function(){o.prop("disabled",!0),t.prop("disabled",!0);var e=$('<img src="/img/loading_small.gif" class="loading" alt="Loading..." />');n.prepend(e),n.find(".result").fadeOut(200,function(){$(this).remove()})},success:function(e,o,a){n.find(".result").remove();var i=$(e);i.hide(),n.prepend(i),i.fadeIn(500),t.val("")},error:function(e,t,o){alert("There was an error sending that message. ("+t+")")},complete:function(){o.prop("disabled",!1),t.prop("disabled",!1),n.find(".loading").remove()}})})}},recentActivity={init:function(){var e=$("#recent");e.find(".nav a").click(function(t){t.preventDefault();var o=$(this);$.ajax({url:o.attr("href"),beforeSend:function(){e.fadeTo(200,.5)},success:function(t){e.fadeOut(100,function(){e.html(t),e.fadeTo(100,1)})},error:function(){e.fadeTo(200,1),alert("Whoops. There was an error. Please try again.")}})})}},scroll={init:function(){this.hashTargets("comment")&&this.toComment(),$(window).on("hashchange",function(e){e.preventDefault(),scroll.toComment()})},hashTargets:function(e){return"comment"==e&&location.hash.match(/^#c\d+$/)},toComment:function(){var e=location.hash.replace("#","").replace("c","");this.to("[data-comment-id="+e+"]")},to:function(e){var t=$(e);0!==t.length&&$(window).scrollTo(t,1e3,{interrupt:!0,offset:-100})}},search={init:function(){$("#header-search input").on("input",function(){var e=$(this),t=e.val(),o=t.replace(" ","");t!=o&&e.val(o),search.filterCloud(t)})},filterCloud:function(e){var t=$("#frontpage_cloud");if(0!==t.length)return""===e?void t.find("a").show():void t.find("> a.thoughtword").each(function(){var t=$(this),o=$(t).html().trim();o.search(e)===-1?t.hide():t.show()})}},suggestedWords={init:function(){$("#suggested-words button").click(function(e){e.preventDefault();var t=$(this).html();$("#word").val(t),$("#suggested-words").slideUp(),$("#thought").focus()})}},wordCoalesceTest={init:function(){var e=$("#test-words a");e.each(function(){var e=$(this),t=e.html(),o=t.split("");e.html("");for(var n=0;n<o.length;n++)e.append("<span>"+o[n]+"</span>")}),e.click(function(e){e.preventDefault();var t=$(this),o=t.find("span"),n=[];o.each(function(){n.push($(this).html())}),$("#test-words a[data-word!="+$(this).data("word")+"]").each(function(){var e=$(this),t=e.find("span");t.each(function(){var e=$(this),t=$(this).clone();t.css({zIndex:2,position:"absolute"}),t.addClass("clone"),e.before(t),e.css({opacity:0})}),t=e.find("span.clone"),t.each(function(){var e=$(this);return n.indexOf(e.html())==-1?void e.animate({opacity:0},2e3):void o.each(function(){if(receiverLetter=$(this),receiverLetter.html()==e.html())return e.animate({left:receiverLetter.position().left,top:receiverLetter.position().top},3e3,"swing",function(){$(this).fadeOut(200,function(){$(this).remove()})}),!1})})})})}};